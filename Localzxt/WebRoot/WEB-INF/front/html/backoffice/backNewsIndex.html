<div class="breadcrumbs" id="breadcrumbs">
	<ul class="breadcrumb">
		<li>
			<i class="icon-home home-icon"></i>
			<a href="backHome.ofcx">首页</a>
		</li>

		<li>
			<a href="#">信息审核</a>
		</li>
		<li class="active">网站公告</li>
	</ul>
</div>
<!--./弹出框-->
<div class="ui-widget-overlay" style="display:none;  height: 100%; width: 100%; position: fixed; left: 0px; top: 0px; z-index: 1049; opacity: 0.3;"></div>
<div class="ui-widget ui-widget-content ui-corner-all ui-jqdialog jqmID3" id="editmodgrid-table" dir="ltr" tabindex="-1" role="dialog" aria-labelledby="edithdgrid-table" aria-hidden="false" style="z-index: 1050; overflow: hidden; top: 256px; left: 214px; display: none;">
	<div class="ui-jqdialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix" id="edithdgrid-table" style="cursor: move;">
		<div class="widget-header"><span class="ui-jqdialog-title" style="float: left;">新增数据</span>
			<a href="javascript:void(0)" class="ui-jqdialog-titlebar-close ui-corner-all" style="right: 0.3em;"><span class="ui-icon ui-icon-closethick"></span></a>
		</div>
	</div>
	<div class="ui-jqdialog-content ui-widget-content" id="editcntgrid-table">
		<div>
			<form name="FormPost" id="FrmGrid_grid-table" class="FormGrid" onsubmit="return false;" style="width:auto;overflow:auto;position:relative;height:auto;">
				<table id="TblGrid_grid-table" class="EditTable" cellspacing="0" cellpadding="0" border="0">
					<tbody>
						<tr id="FormError" style="display:none">
							<td class="ui-state-error" colspan="2"></td>
						</tr>
						<tr style="display:none" class="tinfo">
							<td class="topinfo" colspan="2"></td>
						</tr>
						<tr rowpos="1" class="FormData" id="tr_id">
							<td class="CaptionTD">新闻标题</td>
							<td class="DataTD">&nbsp;<input type="text" id="addTitle" name="title" role="textbox" class="FormElement ui-widget-content ui-corner-all"></td>
						</tr>
						<tr rowpos="2" class="FormData" id="tr_sdate">
							<td class="CaptionTD">新闻类别</td>
							<td class="DataTD">&nbsp;
								<select name="type" id="addType">
								</select>
							</td>
						</tr>
						<tr rowpos="3" class="FormData" id="tr_stock">
							<td class="CaptionTD">显示方式</td>
							<td class="DataTD">&nbsp;
								<select name="orderBy" id="addOrderBy">
								</select>
							</td>
						</tr>
						<tr rowpos="4" class="FormData" id="tr_ship">
							<td class="CaptionTD">内容</td>
							<td class="DataTD">&nbsp;
								<div class="col-xs-11">
									<div class="wysiwyg-editor  col-xs-12 " id="contentArea"></div>
								</div>
							</td>
						</tr>
						<tr class="FormData" style="display:none">
							<td class="CaptionTD"></td>
							<td colspan="1" class="DataTD"><input class="FormElement" id="id_g" type="text" name="grid-table_id" value="_empty"></td>
						</tr>
					</tbody>
				</table>
			</form>
			<table border="0" cellspacing="0" cellpadding="0" class="EditTable" id="TblGrid_grid-table_2">
				<tbody>
					<tr>
						<td colspan="2">
							<hr class="ui-widget-content" style="margin:1px">
						</td>
					</tr>
					<tr id="Act_Buttons">
						<td class="EditButton">
							<a href="javascript:void(0)" id="sData" opr_type="add" class="fm-button ui-state-default ui-corner-all fm-button-icon-left btn btn-sm btn-primary"><i class="icon-ok"></i>提交</a>
							<a href="javascript:void(0)" id="cData" class="fm-button ui-state-default ui-corner-all fm-button-icon-left btn btn-sm"><i class="icon-remove"></i>取消</a>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>
<div class="page-content">
	<div class="row">
		<div class="page-header">
			<fieldset>
				<label for="title">新闻标题：</label>
				<input type="text" placeholder="新闻标题" id='title' name="title">
				<label for="type">类别：</label>
				<select id="type" >
					<option value="">选择类别</option>
				</select>
				<label for="orderBy">显示方式：</label>
				<select id="orderBy">
					<option value="">选择显示方式</option>
				</select>
				<button type="button" class="btn btn-info btn-sm" onclick="searchInfoList();"><i class="icon-search"></i>搜索</button>
				<button type="button" class="btn btn-danger btn-sm"><i class="icon-refresh"></i>重置</button>
			</fieldset>
		</div>
		<div class="header lighter">
				<h3>
				<button type="button" id="add_news" class="btn btn-success btn-sm"><i class="icon-plus-sign"></i>添加</button>
			</h3>
		</div>
		<!--./page-header-->

		<div class="col-xs-12">
			<!-- PAGE CONTENT BEGINS -->
			<table id="informationGrid"></table>
			<div class="noRecord">未查询到记录</div>
			<div class="tcdPageCode"></div>
			<!-- PAGE CONTENT ENDS -->
		</div>
	</div>
</div>
<!-- form弹窗样式 -->
<style type="text/css">
	fieldset select,
	fieldset input {
		margin-right: 20px;
	}
	#editmodgrid-table{
		width: 800px;
		height: 600px;
	}
	.noRecord{
		display: none;
	}
</style>
<script src="front/js/backoffice/bootstrap.min.js" type='text/javascript'></script>
<script src="front/js/backoffice/date-time/bootstrap-datepicker.min.js"></script>
<script src="front/js/backoffice/jqGrid/jquery.jqGrid.min.js"></script>
<script src="front/js/backoffice/jqGrid/i18n/grid.locale-en.js"></script>
<script src="front/js/basicParameter.js"></script>
<script src="front/js/tools.js"></script>
<script src="front/js/pcweb/page.js"></script>
<script src="front/js/backoffice/markdown/markdown.min.js"></script>
<script src="front/js/backoffice/markdown/bootstrap-markdown.min.js"></script>
<script src="front/js/backoffice/jquery.hotkeys.min.js"></script>
<script src="front/js/backoffice/bootstrap-wysiwyg.min.js"></script>
<script src="front/js/backoffice/bootbox.min.js"></script>
<link rel="stylesheet" type="text/css" href="front/css/pcweb/page.css"></link>
<script type="text/javascript">

	var grid_selector = "#informationGrid";
	jQuery(function($) {
jQuery(grid_selector).jqGrid({
			datatype: "local",
			height: 450,
			colNames: ['ID', '状态', '文章名称','类型', '时间',  '显示方式','操作'],
			colModel: [
				{ name: 'newsId', index: 'newsId', hidden : true },
				{ name: 'state', index: 'state', hidden : true },
				{ name: 'title', index: 'title'},
				{ name: 'type', index: 'type', width: 40},
				{ name: 'docCreateTime', index: 'docCreateTime', width: 70},
				{ name: 'orderBy', index: 'orderBy', width: 40},
				{ name:'operation',index:'operation',width:80,sortable:false,fixed : true,resize : false,
					formatter:loadHandleBtn,
				}
			],
			viewrecords: true,
			altRows: true,
			rownumbers: true,
			loadComplete: function() {
			},
			autowidth: true,
			
		});


		function style_delete_form(form) {
			var buttons = form.next().find('.EditButton .fm-button');
			buttons.addClass('btn btn-sm').find('[class*="-icon"]').remove(); //ui-icon, s-icon
			buttons.eq(0).addClass('btn-danger').prepend('<i class="icon-trash"></i>');
			buttons.eq(1).prepend('<i class="icon-remove"></i>')
		}


		function beforeDeleteCallback(e) {
			var form = $(e[0]);
			if (form.data('styled')) return false;

			form.closest('.ui-jqdialog').find('.ui-jqdialog-titlebar').wrapInner('<div class="widget-header" />')
			style_delete_form(form);
			form.data('styled', true);
			$("#dData").click(function() {
				var id = $(grid_selector).jqGrid('getGridParam', 'selrow');
				var rowDatas = $(grid_selector).jqGrid('getRowData', id);
				deleteInfo(rowDatas.sysId);
			});
		}
		searchInfoList(0);
		formLook();
		initContextEdit();
	});
	
	function initContextEdit(){
		$('#contentArea').ace_wysiwyg({
			toolbar : ['font',null,'fontSize',null,
				{name : 'bold',className : 'btn-info'},
				{name : 'italic',className : 'btn-info'},
				{name : 'strikethrough',className : 'btn-info'},
				{name : 'underline',className : 'btn-info'},
				null,
				{name : 'insertunorderedlist',className : 'btn-success'},
				{name : 'insertorderedlist',className : 'btn-success'},
				{name : 'outdent',className : 'btn-purple'},
				{name : 'indent',className : 'btn-purple'},
				null,
				{name : 'justifyleft',className : 'btn-primary'},
				{name : 'justifycenter',className : 'btn-primary'},
				{name : 'justifyright',className : 'btn-primary'},
				{name : 'justifyfull',className : 'btn-inverse'},
				null,
				{name : 'createLink',className : 'btn-pink'},
				{name : 'unlink',className : 'btn-pink'},
				null,
				{name : 'insertImage',className : 'btn-success'},
				null,'foreColor',null,
				{name : 'undo',className : 'btn-grey'},
				{name : 'redo',className : 'btn-grey'}
			],
			'wysiwyg' : {fileUploadError : showErrorAlert}
		}).prev().addClass('wysiwyg-style2');
	}
	//格式化行内按钮，根据不同的状态显示不同的按钮
	function loadHandleBtn(cellValue, options, rowdata, action){
		var handleBtn = "";
		 return "<div title='编辑选定行' style='float:left;cursor:pointer;'class='ui-pg-div ui-inline-edit'><span class='ui-icon ui-icon-pencil' onclick='Modify(" + rowdata.newsId + ")'></span></div>"
		 +"<div title='删除选中行' style='float:left;margin-left:5px;' class='ui-pg-div ui-inline-del'><span class='ui-icon ui-icon-trash' onclick='Delete(" + rowdata.newsId + ")'></span></div>";
	}
	function searchInfoList(pageStart){
		$.ajax({
		    async: false,
		    url: "newsList.ofc",
		    type: "POST",
		    data : {
		    	nowPage:pageStart||0,
		    	pageSize:10,
		    	title:$("#title").val(),
		    	type:$("#type option:selected").val(),
		    	orderBy:$("#orderBy option:selected").val(),
		    },
		    dataType: "json",
		}).done(function (result) {
			commonTip(result, function(){
			
				 $("#informationGrid").jqGrid('clearGridData');  //清空表格
				$("#informationGrid").jqGrid('setGridParam',{  // 重新加载数据
				      datatype:'local',
				      data : result.data.newsList,   //  newdata 是符合格式要求的需要重新加载的数据 
				}).trigger("reloadGrid"); 
				if(result.data.newsList.length>0){
					$(".tcdPageCode").createPageBar({
						pageCount : result.data.pageCount,
						nowPage : (pageStart || 0) + 1,
						pageSize : 10,
						totalCount: result.data.totalCount,
						backFunction:function(pageStart,pageSize){
							nowPage = pageStart;
							searchInfoList(pageStart - 1);
						}
					});
					$(".noRecord").hide();
				}else{
					$(".noRecord").show();
					$(".tcdPageCode").html("");
				}
			});
		}).fail(function () {
			bootBox.alert("获取信息列表失败！");
		}).always(function () {
			
		});
	}
	function formLook(){
		$.ajax({
		    async: false,
		    url: "newsForm.ofc",
		    type: "POST",
		    dataType: "json"
		}).done(function (result) {
			commonTip(result,function(){
				$("#type").html('<option value="">选择类别</option>');
				$("#orderBy").html('<option value="">选择显示方式</option>');
				var newsTypes = result.data.newsTypes;
				var newsOrderBys = result.data.newsOrderBys;
				for(var i=0;i<newsTypes.length;i++){
					var opt = '<option';
					opt+=' value="'+newsTypes[i].name+'">'+newsTypes[i].value+'</option>';
					$("#type").append(opt); 
					} 
				for(var i=0;i<newsOrderBys.length;i++){
					var opt = '<option';
					opt+=' value="'+newsOrderBys[i].name+'">'+newsOrderBys[i].value+'</option>';
					$("#orderBy").append(opt); 
					} 
			});
		});
	}
	
	//点击添加按钮
	$("#add_news").click(function(){
	$("#sdata").attr("opr_type","add");
		$(".ui-widget-overlay").show();
		$("#editmodgrid-table").show();
		$("#addTitle").val("");
		$("#contentArea").html("");
		$.ajax({
		    async: false,
		    url: "newsForm.ofc",
		    type: "POST",
		    dataType: "json"
		}).done(function (result) {
			commonTip(result,function(){
				$("#addType").html('<option value="">选择类别</option>');
				$("#addOrderBy").html('<option value="">选择显示方式</option>');
				var newsTypes = result.data.newsTypes;
				var newsOrderBys = result.data.newsOrderBys;
				
				for(var i=0;i<newsTypes.length;i++){
					var opt = '<option';
					opt+=' value="'+newsTypes[i].name+'">'+newsTypes[i].value+'</option>';
					$("#addType").append(opt); 
					} 
				for(var i=0;i<newsOrderBys.length;i++){
					var opt = '<option';
					opt+=' value="'+newsOrderBys[i].name+'">'+newsOrderBys[i].value+'</option>';
					$("#addOrderBy").append(opt); 
					} 
			});
		});
	});
	function showErrorAlert(reason, detail) {
		var msg = '';
		if (reason === 'unsupported-file-type') {
			msg = "Unsupported format " + detail;
		}
		$('<div class="alert"> <button type="button" class="close" data-dismiss="alert">&times;</button>' +
			'<strong>File upload error</strong> ' + msg + ' </div>').prependTo('#alerts');
	}
	
	//提交新增新闻
	$("#sData").click(function(){
	if($(this).attr("opr_type")=="add")
  		$.ajax({
  			type:"post",
  			url:"saveNews.ofc",
  			data : {
		    	title:$("#addTitle").val(),
		    	type:$("#addType option:selected").val(),
		    	orderBy:$("#addOrderBy option:selected").val(),
		    	content:$("#contentArea").html(),
		    }
  		}).done(function (data) {
  			commonTip(data, function(){
  				bootbox.alert(data.success);
	  			$("#newsManager").click();
  			});
  		});
		//修改
		if($(this).attr("opr_type")=="edit"){
			$.ajax({
				type:"post",
				url:"updateNews.ofc",
				data:{"newsId":$("#FrmGrid_grid-table").attr("newsId"),
				"title":$("#FrmGrid_grid-table").find("input[name='title']").val(),
				"type":$("#FrmGrid_grid-table").find("select[name='type'] option:selected").val(),
				"orderBy":$("#FrmGrid_grid-table").find("select[name='orderBy'] option:selected").val(),
				 "content":$("#contentArea").html()},
			}).done(function(result){
				commonTip(result, function(){
					if(result.success)
						bootbox.alert(result.success);
					if(result.err)
						bootbox.alert(result.err);
					$("#newsManager").click();
				});
			});
		}
	});
	
	//点击删除
	function Delete(id){
	var newsId = id;
		bootbox.confirm({
			message: "确定删除当前行？",
			buttons: {
				confirm: {
					label: '确定',
					className: 'btn-success'
				},
				cancel: {
					label: '取消',
					className: 'btn-danger'
				}
			},
			callback: function(result) {
				if(result){
					$.ajax({
						type:"post",
						url:"deleteNews.ofc",
						data:{"newsId":newsId}
					}).done(function(result){
						commonTip(result, function(){
							if(result.success)
								bootbox.alert(result.success);
							if(result.err)
								bootbox.alert(result.err);
							$("#newsManager").click();
						});
					});
				}
			}
		});
	}
	
	
	$("#sData,#cData,.ui-jqdialog-titlebar-close").on("click", function() {
		$(".ui-widget-overlay").hide();
		$("#editmodgrid-table").hide();
	});
	$(".id").on("click",function(){
		$(".ui-widget-overlay").show();
		$("#editmodgrid-table").show();
	})
	
	//点击修改新闻按钮
	function Modify(id){
		$.ajax({
			type:"post",
			url:"editNews.ofc",
			data:{"newsId":id},
		}).done(function (result) {
			commonTip(result, function(){
				var newsTypes = result.data.newTypes;
				$("select[name='type']").html("");
				for(var i=0;i<newsTypes.length;i++){
					var option = null;
					if(newsTypes[i].value==result.data.newsInfo.type){
						option = '<option value="'+newsTypes[i].name+'" selected = "selected">'+newsTypes[i].value+'</option>';
					}else{
						option = '<option value="'+newsTypes[i].name+'">'+newsTypes[i].value+'</option>';
					}
					$("select[name='type']").append(option);
				}
				var newsOrderBys = result.data.newsOrderBys;
				$("select[name='orderBy']").html("");
				for(var j=0;j<newsOrderBys.length;j++){
					var option = null;
					if(newsOrderBys[j].value==result.data.newsInfo.orderBy){
						option = '<option value="'+newsOrderBys[j].name+'" selected="selected">'+newsOrderBys[j].value+'</option>';
					}else{
						option = '<option value="'+newsOrderBys[j].name+'">'+newsOrderBys[j].value+'</option>';
					}
					$("select[name='orderBy']").append(option);
				}
				$("#FrmGrid_grid-table").find("input[name='title']").val(result.data.newsInfo.title);
				$("#contentArea").load(result.data.newsInfo.contentUrl);
				$("#sData").attr("opr_type","edit");
				$("#FrmGrid_grid-table").attr("newsId",result.data.newsInfo.newsId);
				$(".ui-widget-overlay").show();
		$("#editmodgrid-table").show();
			});
		}).fail(function () {
			bootbox.alert("获取信息列表失败！");
		}).always(function () {
			
		});
	}
</script>